# Discord LLM Verification Bot

## Description

This Discord bot is designed to automate the user verification process within a server. It leverages a Large Language Model (LLM) via OpenWebUI (or a compatible API) to interact with users, classify their skills, experience, and operating systems, and assign appropriate roles. The bot aims to ensure all users are eventually categorized as either "verified" or "unverified."

## Features

* **Automated New User Verification:** Sends a Direct Message (DM) to new members to initiate the verification process.
* **LLM-Driven Interaction:** Engages users in a DM conversation powered by an LLM to gather information.
* **Role Classification:** The LLM classifies user input into predefined categories (e.g., Programming Languages, Experience Level, OS) based on existing server roles.
* **Automatic Role Assignment:** Assigns "verified," "unverified," and specific skill/experience/OS roles based on the verification outcome.
* **Handles Partial Information:** Can grant "verified" status even if only partial information is provided, encouraging further updates.
* **Retry Mechanism:** Allows users multiple attempts if initial information is insufficient.
* **Admin Commands:** Provides tools for manual user verification, batch verification, cleanup of stale verifications, and rebuilding the LLM's understanding of server roles.
* **User Self-Service:** Allows users to initiate or re-attempt verification themselves.
* **Configurable:** Highly configurable via a `.env` file (API keys, Role IDs, Channel IDs, etc.).
* **Dynamic Role Categorization:** Bot learns and categorizes relevant server roles using the LLM at startup.
* **Admin Notifications:** Notifies admins about skills users mention for which no server role currently exists.
* **LLM-Generated Welcome Message:** Sends a welcome message (generated by the LLM) to a designated channel when a new user joins.
* **Comprehensive Logging:** Detailed logging for monitoring and debugging.
* **Docker Support:** Includes `Dockerfile` and `docker-compose.yml` for easy deployment.

## Prerequisites

* Python 3.8+
* A Discord Bot Token (from the [Discord Developer Portal](https://discord.com/developers/applications))
* Access to an OpenWebUI (or compatible) LLM API endpoint and an API token.
* Docker and Docker Compose (recommended for deployment, optional for local development).
* Pre-created roles in your Discord server for:
    * The main "verified" status.
    * The main "unverified" status.
    * A temporary "verificationinprogress" status.
    * Any roles that will act as admin roles for the bot.
    * (Skill, Experience, OS roles can be pre-created; the bot will categorize them. If they don't exist, the bot can notify admins when users mention them.)

##  Permissions and Intents

For the bot to work correctly, you must configure its permissions and intents.

### **Privileged Gateway Intents**

These must be enabled in your **Discord Developer Portal** (under your Application > Bot > Privileged Gateway Intents).

* **Server Members Intent:** **(Required)** Allows the bot to see new members joining, access the server's member list for batch commands, and reliably retrieve member information.
* **Message Content Intent:** **(Required)** Allows the bot to read the content of messages, which is essential for the verification process in DMs.

### **Bot Permissions**

These permissions are granted when you invite the bot to your server. Generate an invite link using the "OAuth2 URL Generator" in the Developer Portal with the `bot` and `applications.commands` scopes selected.

* **Manage Roles:** **(Required)** To assign/remove `verified`, `unverified`, and skill roles.
* **Send Messages:** To send DMs and messages to welcome/notification channels.
* **View Channels:** To see the channels it needs to post messages in.
* **Use Application Commands:** For users to be able to use slash commands.
* **Read Message History:** To maintain context in DM conversations.
* **Embed Links:** (Recommended) To properly format URLs in messages.

***Note:*** *Ensure the bot's role is higher in the server's role hierarchy than the roles it needs to manage.*
[url](https://discord.com/oauth2/authorize?client_id=1377667083986403428&permissions=2416004096&integration_type=0&scope=bot)

## üöÄ Setup Instructions

1.  **Clone the Repository:**
    ```bash
    git clone <your-repository-url>
    cd <repository-name>
    ```

2.  **Create a Virtual Environment (Recommended):**
    ```bash
    python -m venv venv
    source venv/bin/activate  # On Windows: venv\Scripts\activate
    ```

3.  **Install Dependencies:**
    ```bash
    pip install -r requirements.txt
    ```

4.  **Configure Environment Variables:**
    * Copy the example `.env.example` file to a new file named `.env`:
        ```bash
        cp .env.example .env
        ```
    * Open the `.env` file and fill in the required values. See the **Configuration Details** section below for an explanation of each variable.

5.  **Initial Bot Startup & Role Categorization:**
    * When the bot starts for the first time (or if `REBUILD_ROLE_CATEGORIES_ON_STARTUP` is set to `true` in `.env`), it will fetch all roles from your server.
    * It will then use the LLM to categorize these roles into "Programming Language," "Experience Level," and "OS" (or as configured in your prompts).
    * This categorized list of roles is saved to `data/categorized_roles.json` (this path might vary based on implementation) and used by the LLM during user verification.

## ‚ñ∂Ô∏è Running the Bot

### Locally
```bash
python main.py
```

### Using Docker
```bash
docker-compose up -d --build
```
To stop the Docker container:

```bash
docker-compose down
```

## Configuration Details (.env variables)

Create a .env file in the root of your project with the following variables:

Precedence: environment variables provided to the process override values in `.env`. The values declared in `config.py` act as defaults when no env value is provided.

| Variable                             | Description                                                                                              | Example Value                                    |
| ------------------------------------ | -------------------------------------------------------------------------------------------------------- | ------------------------------------------------ |
| `DISCORD_BOT_TOKEN`                  | Your Discord bot token.                                                                                  | `Mxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx` |
| `LLM_API_URL`                        | The full URL to your OpenWebUI (or compatible) chat completions API endpoint.                            | `http://localhost:3000/api/chat/completions`     |
| `LLM_API_TOKEN`                      | Bearer token for authenticating with the LLM API.                                                        | `your_llm_api_token_here`                        |
| `LLM_MODEL_NAME`                     | The model name to be used for LLM interactions.                                                          | `granite3.1-dense:8b`                            |
| `VERIFIED_ROLE_ID`                   | ID of the role to assign upon successful verification.                                                   | `123456789012345678`                             |
| `UNVERIFIED_ROLE_ID`                 | ID of the role for unverified users.                                                                     | `123456789012345679`                             |
| `VERIFICATION_IN_PROGRESS_ROLE_ID`   | ID of the temporary role while a user is in the verification DM flow.                                    | `123456789012345680`                             |
| `ADMIN_ROLE_IDS`                     | Comma-separated list of Discord Role IDs that can use admin commands.                                    | `111111111111111111,222222222222222222`          |
| `NOTIFICATION_CHANNEL_ID`            | ID of the channel where admins are notified of skills mentioned by users but not yet available as roles. | `123456789012345681`                             |
| `WELCOME_CHANNEL_ID`                 | ID of the channel where the LLM-generated welcome message for new users is sent.                         | `123456789012345682`                             |
| `VERIFICATION_RETRIES`               | Number of times the bot will re-prompt a user if information is insufficient.                            | `3`                                              |
| `REBUILD_ROLE_CATEGORIES_ON_STARTUP` | Set to `true` to force LLM categorization of server roles on next startup (defaults to `false`).         | `false`                                          |
| `LOG_LEVEL`                          | Logging level for the application (e.g., `INFO`, `DEBUG`, `WARNING`).                                    | `INFO`                                           |
| `PROMPT_FILE_ROLE_CATEGORIZATION`    | Path to the prompt file used for initial LLM role categorization.                                        | `prompts/role_categorization_prompt.txt`         |
| `PROMPT_FILE_USER_VERIFICATION`      | Path to the base prompt file for user verification conversations (if applicable).                        | `prompts/user_verification_prompt.txt`           |
| `SUSPICIOUS_ROLE_ID`                 | Role assigned to accounts flagged as suspicious (optional).                                              | `1426422431886741545`                           |
| `SUSPICIOUS_CHECK_INTERVAL_HOURS`    | How often (in hours) the background suspicious-check task runs.                                          | `24`                                             |
| `SUSPICIOUS_ROLE_RETENTION_DAYS`     | How many days to keep the suspicious role before automatic removal (if configured).                       | `7`                                              |
| `WELCOME_TEMPERATURE`                | Temperature used when generating welcome messages (0.0 - 1.0).                                           | `0.7`                                            |
| `WELCOME_HARDCODE`                   | If `true`, use the `WELCOME_HARDCODE_MESSAGE` instead of calling the LLM for welcome text (useful for testing). | `false`                                  |
| `WELCOME_HARDCODE_MESSAGE`           | The static fallback welcome message used when `WELCOME_HARDCODE=true`.                                   | `"Bienvenido..."`                              |
| `WELCOME_MAX_PROMPT_CHARS`           | Max characters of the welcome system prompt sent to the LLM to avoid truncation.                          | `1200`                                           |
| `WELCOME_MAX_RESPONSE_TOKENS`        | Max tokens to request from the LLM when generating a welcome message.                                      | `300`                                            |
| `DEFAULT_MAX_TOKENS`                 | Global default max tokens requested from the LLM when a per-call override isn't provided.                  | `4096`                                           |

Notes on increasing token limits:
- Raising `DEFAULT_MAX_TOKENS` or per-call max tokens (e.g., `WELCOME_MAX_RESPONSE_TOKENS`) can reduce truncation but will use more model compute and may exceed model or infrastructural limits. Increase cautiously and verify your LLM supports the requested size.
- If you hit model-imposed limits or cost constraints, prefer trimming prompts (we provide smart-trim) or summarizing role lists instead of unbounded increases.


## Bot Usage / Commands
### Admin Commands

These commands are typically grouped under /admin and require the user to have one of the roles specified in ADMIN_ROLE_IDS.

- /admin verify-user @member
    - Manually triggers the verification DM process for the specified server member.

- /admin initiate-verification-batch count:<number>
    - Selects the specified count of users with the "unverified" role.
    - Assigns them the "verificationinprogress" role and sends them the verification DM.

- /admin reset-stale-verifications
    - Identifies users who have the "verificationinprogress" role but haven't completed verification.
    - Also identifies existing server members who have neither a "verified" nor "unverified" role.
    - Removes "verificationinprogress" and assigns "unverified" to these users.

- /admin rebuild-role-categories
    - Manually triggers the process for the bot to re-fetch all server roles, send them to the LLM for categorization, and update its internal list of assignable roles (e.g., data/categorized_roles.json).

### User Commands

- /assign-roles
    - Allows a user to self-initiate or re-attempt the verification DM process to get their roles assigned or updated.

### Automatic Actions

- New Member Verification: When a new user joins the server, they will automatically receive a DM from the bot to start the verification process.
- LLM-Generated Welcome: A welcome message, generated by the LLM, will be posted to the channel specified by WELCOME_CHANNEL_ID when a new user joins.

## Prompts

The effectiveness of the LLM heavily relies on well-crafted prompts. This bot uses external prompt files for key LLM interactions:

- Initial Role Categorization: The prompt defined in PROMPT_FILE_ROLE_CATEGORIZATION (e.g., prompts/role_categorization_prompt.txt) instructs the LLM on how to categorize your existing server roles into groups like "Programming Language," "Experience Level," and "OS." You can customize this prompt to change the categories or the logic.
- User Verification: The prompts guiding the conversation with the user for verification (defined in PROMPT_FILE_USER_VERIFICATION or similar, or constructed dynamically) are crucial. Ensure they clearly ask for the desired information and guide the LLM to provide helpful responses and accurate classifications.

These files will be located in the prompts/ directory.
## Logging

The bot uses Python's built-in logging module.

- The LOG_LEVEL in the .env file controls the verbosity of logs.
- Logs are typically output to the console and/or a log file, depending on the configuration in main.py or a dedicated logging setup module.